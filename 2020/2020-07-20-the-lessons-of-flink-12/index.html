<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="追寻原风景">
  
  
  
  <link rel="prev" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-11/" />
  <link rel="next" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-13/" />
  <link rel="canonical" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-12/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           第11讲：Flink CEP 复杂事件处理 | 枕霞惜友
       
  </title>
  <meta name="title" content="第11讲：Flink CEP 复杂事件处理 | 枕霞惜友">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xiaohao890809.github.io"
    },
    "articleSection" : "posts",
    "name" : "第11讲：Flink CEP 复杂事件处理",
    "headline" : "第11讲：Flink CEP 复杂事件处理",
    "description" : "你好，欢迎来到第 11 课时，这一课时将介绍 Flink 中提供的一个很重要的功能：复杂事件处理 CEP。\n背景 Complex Event Processing（CEP）是 Flink 提供的一个非常亮眼的功能，关于 CEP 的解释我们引用维基百科中的一段话：\n CEP, is event processing that combines data from multiple sources to infer events or patterns that suggest more complicated circumstances. The goal of complex event processing is to identify meaningful events (such as opportunities or threats) and respond to them as quickly as possible.\n 在我们的实际生产中，随着数据的实时性要求越来越高，实时数据的量也在不断膨胀，在某些业务场景中需要根据连续的实时数据，发现其中有价值的那些事件。\n说到底，Flink 的 CEP 到底解决了什么样的问题呢？\n比如，我们需要在大量的订单交易中发现那些虚假交易，在网站的访问日志中寻找那些使用脚本或者工具“爆破”登录的用户，或者在快递运输中发现那些滞留很久没有签收的包裹等。\n如果你对 CEP 的理论基础非常感兴趣，推荐一篇论文“Efﬁcient Pattern Matching over Event Streams”。",
    "inLanguage" : "en-us",
    "author" : "王知无",
    "creator" : "王知无",
    "publisher": "王知无",
    "accountablePerson" : "王知无",
    "copyrightHolder" : "王知无",
    "copyrightYear" : "2020",
    "datePublished": "2020-07-20 10:23:48 \u002b0000 UTC",
    "dateModified" : "2020-07-20 10:23:48 \u002b0000 UTC",
    "url" : "https:\/\/xiaohao890809.github.io\/2020\/2020-07-20-the-lessons-of-flink-12\/",
    "wordCount" : "455",
    "keywords" : [ "42讲轻松通关Flink", "枕霞惜友"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
        <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <div class="top-scroll-bar"></div>
    
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">第11讲：Flink CEP 复杂事件处理</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xiaohao890809.github.io" rel="author">王知无</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-07-20 itemprop="datePublished">July 20, 2020</time>
                </span>
                
        </div>
    </header>

    
          <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#程序结构">程序结构</a></li>
    <li><a href="#模式定义">模式定义</a>
      <ul>
        <li><a href="#简单模式">简单模式</a></li>
        <li><a href="#联合模式">联合模式</a></li>
        <li><a href="#匹配后的忽略模式">匹配后的忽略模式</a></li>
      </ul>
    </li>
    <li><a href="#源码解析">源码解析</a></li>
    <li><a href="#实战案例">实战案例</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>
<script type="text/javascript">
  window.onload = function () {
    var fix = $('.post-toc');
    var end = $('.post-comment');
    var fixTop = fix.offset().top, fixHeight = fix.height();
    var endTop, miss;
    var offsetTop = fix[0].offsetTop;
    $(window).scroll(function () {
      var docTop = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
      if (end.length > 0) {
        endTop = end.offset().top;
        miss = endTop - docTop - fixHeight;
      }
      if (fixTop < docTop) {
        fix.css({ 'position': 'fixed' });
        if ((end.length > 0) && (endTop < (docTop + fixHeight))) {
          fix.css({ top: miss });
        } else {
          fix.css({ top: 0 });
        }
      } else {
        fix.css({ 'position': 'absolute' });
        fix.css({ top: offsetTop });
      }
    })
  }
</script> 
    

    <script type="text/javascript">
            window.MathJax = {
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
            TeX: {equationNumbers: {autoNumber: "AMS"}},
            showProcessingMessages: false,
            messageStyle: 'none'
        };
   </script>

    <script type="text/javascript" async src="/lib/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>

    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <p>你好，欢迎来到第 11 课时，这一课时将介绍 Flink 中提供的一个很重要的功能：复杂事件处理 CEP。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E6%8B%86%E5%88%86%E6%B5%81.png" data-sizes="auto" alt="拆分流" title="拆分流" class="lazyload"><figcaption class="image-caption">拆分流</figcaption></figure></p>
<h2 id="背景">背景</h2>
<p>Complex Event Processing（CEP）是 Flink 提供的一个非常亮眼的功能，关于 CEP 的解释我们引用维基百科中的一段话：</p>
<blockquote>
<p>CEP, is event processing that combines data from multiple sources to infer events or patterns that suggest more complicated circumstances. The goal of complex event processing is to identify meaningful events (such as opportunities or threats) and respond to them as quickly as possible.</p>
</blockquote>
<p>在我们的实际生产中，随着数据的实时性要求越来越高，实时数据的量也在不断膨胀，在某些业务场景中需要根据连续的实时数据，发现其中有价值的那些事件。</p>
<p>说到底，Flink 的 CEP 到底解决了什么样的问题呢？</p>
<p>比如，我们需要在大量的订单交易中发现那些虚假交易，在网站的访问日志中寻找那些使用脚本或者工具“爆破”登录的用户，或者在快递运输中发现那些滞留很久没有签收的包裹等。</p>
<p>如果你对 CEP 的理论基础非常感兴趣，推荐一篇论文“Efﬁcient Pattern Matching over Event Streams”。</p>
<p>Flink 对 CEP 的支持非常友好，并且支持复杂度非常高的模式匹配，其吞吐和延迟都令人满意。</p>
<h2 id="程序结构">程序结构</h2>
<p>Flink CEP 的程序结构主要分为两个步骤：</p>
<ul>
<li>定义模式</li>
<li>匹配结果</li>
</ul>
<p>我们在官网中可以找到一个 Flink 提供的案例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DataStream<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">&gt;</span> input <span style="color:#f92672">=</span> <span style="color:#f92672">...</span>
Pattern<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">,</span> <span style="color:#f92672">?&gt;</span> pattern <span style="color:#f92672">=</span> Pattern<span style="color:#f92672">.&lt;</span>Event<span style="color:#f92672">&gt;</span>begin<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;start&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">where</span><span style="color:#f92672">(</span>
        <span style="color:#66d9ef">new</span> SimpleCondition<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>Event event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 42<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">).</span><span style="color:#a6e22e">next</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;middle&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">subtype</span><span style="color:#f92672">(</span>SubEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">).</span><span style="color:#a6e22e">where</span><span style="color:#f92672">(</span>
        <span style="color:#66d9ef">new</span> SimpleCondition<span style="color:#f92672">&lt;</span>SubEvent<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>SubEvent subEvent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> subEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">getVolume</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> 10<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">).</span><span style="color:#a6e22e">followedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;end&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">where</span><span style="color:#f92672">(</span>
         <span style="color:#66d9ef">new</span> SimpleCondition<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>Event event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;end&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
         <span style="color:#f92672">}</span>
    <span style="color:#f92672">);</span>
PatternStream<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">&gt;</span> patternStream <span style="color:#f92672">=</span> CEP<span style="color:#f92672">.</span><span style="color:#a6e22e">pattern</span><span style="color:#f92672">(</span>input<span style="color:#f92672">,</span> pattern<span style="color:#f92672">);</span>
DataStream<span style="color:#f92672">&lt;</span>Alert<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> patternStream<span style="color:#f92672">.</span><span style="color:#a6e22e">process</span><span style="color:#f92672">(</span>
    <span style="color:#66d9ef">new</span> PatternProcessFunction<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">,</span> Alert<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processMatch</span><span style="color:#f92672">(</span>
                Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">&gt;&gt;</span> pattern<span style="color:#f92672">,</span>
                Context ctx<span style="color:#f92672">,</span>
                Collector<span style="color:#f92672">&lt;</span>Alert<span style="color:#f92672">&gt;</span> out<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
            out<span style="color:#f92672">.</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>createAlertFrom<span style="color:#f92672">(</span>pattern<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
</code></pre></div><p>在这个案例中可以看到程序结构分别是：</p>
<ul>
<li>第一步，定义一个模式 Pattern，在这里定义了一个这样的模式，即在所有接收到的事件中匹配那些以 id 等于 42 的事件，然后匹配 volume 大于 10.0 的事件，继续匹配一个 name 等于 end 的事件；</li>
<li>第二步，匹配模式并且发出报警，根据定义的 pattern 在输入流上进行匹配，一旦命中我们的模式，就发出一个报警。</li>
</ul>
<h2 id="模式定义">模式定义</h2>
<p>Flink 支持了非常丰富的模式定义，这些模式也是我们实现复杂业务逻辑的基础。我们把支持的模式简单做了以下分类，完整的模式定义 API 支持可以参考<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/zh/dev/libs/cep.html#individual-patterns">官网资料</a>。</p>
<h3 id="简单模式">简单模式</h3>
<p><figure><img src="/images/ring.svg" data-src="/images/%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F1.png" data-sizes="auto" alt="简单模式1" title="简单模式1" class="lazyload"><figcaption class="image-caption">简单模式1</figcaption></figure></p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F2.png" data-sizes="auto" alt="简单模式2" title="简单模式2" class="lazyload"><figcaption class="image-caption">简单模式2</figcaption></figure></p>
<h3 id="联合模式">联合模式</h3>
<p><figure><img src="/images/ring.svg" data-src="/images/%E8%81%94%E5%90%88%E6%A8%A1%E5%BC%8F.png" data-sizes="auto" alt="联合模式" title="联合模式" class="lazyload"><figcaption class="image-caption">联合模式</figcaption></figure></p>
<h3 id="匹配后的忽略模式">匹配后的忽略模式</h3>
<p><figure><img src="/images/ring.svg" data-src="/images/%E5%8C%B9%E9%85%8D%E5%90%8E%E7%9A%84%E5%BF%BD%E7%95%A5%E6%A8%A1%E5%BC%8F.png" data-sizes="auto" alt="匹配后的忽略模式" title="匹配后的忽略模式" class="lazyload"><figcaption class="image-caption">匹配后的忽略模式</figcaption></figure></p>
<h2 id="源码解析">源码解析</h2>
<p>我们在上面的官网案例中可以发现，Flink CEP 的整个过程是：</p>
<ul>
<li>从一个 Source 作为输入</li>
<li>经过一个 Pattern 算子转换为 PatternStream</li>
<li>经过 select/process 算子转换为 DataStream</li>
</ul>
<p>我们来看一下 select 和 process 算子都做了什么？</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88.png" data-sizes="auto" alt="做了什么" title="做了什么" class="lazyload"><figcaption class="image-caption">做了什么</figcaption></figure></p>
<p>可以看到最终的逻辑都是在 PatternStream 这个类中进行的。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>R<span style="color:#f92672">&gt;</span> SingleOutputStreamOperator<span style="color:#f92672">&lt;</span>R<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">process</span><span style="color:#f92672">(</span>
      <span style="color:#66d9ef">final</span> PatternProcessFunction<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">,</span> R<span style="color:#f92672">&gt;</span> patternProcessFunction<span style="color:#f92672">,</span>
      <span style="color:#66d9ef">final</span> TypeInformation<span style="color:#f92672">&lt;</span>R<span style="color:#f92672">&gt;</span> outTypeInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">return</span> builder<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>
      outTypeInfo<span style="color:#f92672">,</span>
      builder<span style="color:#f92672">.</span><span style="color:#a6e22e">clean</span><span style="color:#f92672">(</span>patternProcessFunction<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>最终经过 PatternStreamBuilder 的 build 方法生成了一个 SingleOutputStreamOperator，这个类继承了 DataStream。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/SingleOutputStreamOperator.png" data-sizes="auto" alt="SingleOutputStreamOperator" title="SingleOutputStreamOperator" class="lazyload"><figcaption class="image-caption">SingleOutputStreamOperator</figcaption></figure></p>
<p>最终的处理计算逻辑其实都封装在了 CepOperator 这个类中，而在 CepOperator 这个类中的 processElement 方法则是对每一条数据的处理逻辑。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/CepOperator.png" data-sizes="auto" alt="CepOperator" title="CepOperator" class="lazyload"><figcaption class="image-caption">CepOperator</figcaption></figure></p>
<p>同时由于 CepOperator 实现了 Triggerable 接口，所以会执行定时器。所有核心的处理逻辑都在 updateNFA 这个方法中。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/updateNFA.png" data-sizes="auto" alt="updateNFA" title="updateNFA" class="lazyload"><figcaption class="image-caption">updateNFA</figcaption></figure></p>
<p>入口在这里：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processEvent</span><span style="color:#f92672">(</span>NFAState nfaState<span style="color:#f92672">,</span> IN event<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> timestamp<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>SharedBufferAccessor<span style="color:#f92672">&lt;</span>IN<span style="color:#f92672">&gt;</span> sharedBufferAccessor <span style="color:#f92672">=</span> partialMatches<span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessor</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      Collection<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>IN<span style="color:#f92672">&gt;&gt;&gt;</span> patterns <span style="color:#f92672">=</span>
         nfa<span style="color:#f92672">.</span><span style="color:#a6e22e">process</span><span style="color:#f92672">(</span>sharedBufferAccessor<span style="color:#f92672">,</span> nfaState<span style="color:#f92672">,</span> event<span style="color:#f92672">,</span> timestamp<span style="color:#f92672">,</span> afterMatchSkipStrategy<span style="color:#f92672">,</span> cepTimerService<span style="color:#f92672">);</span>
      processMatchedSequences<span style="color:#f92672">(</span>patterns<span style="color:#f92672">,</span> timestamp<span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>NFA 的全称为 <strong>非确定有限自动机</strong>，NFA 中包含了模式匹配中的各个状态和状态间的转换。</p>
<p>在 NFA 这个类中的核心方法是：process 和 advanceTime，这两个方法的实现有些复杂，总体来说可以归纳为，每当一条新来的数据进入状态机都会驱动整个状态机进行状态转换。</p>
<h2 id="实战案例">实战案例</h2>
<p>我们模拟电商网站用户搜索的数据来作为数据的输入源，然后查找其中重复搜索某一个商品的人，并且发送一条告警消息。</p>
<p>代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> StreamExecutionEnvironment env <span style="color:#f92672">=</span> StreamExecutionEnvironment<span style="color:#f92672">.</span><span style="color:#a6e22e">getExecutionEnvironment</span><span style="color:#f92672">();</span>
    env<span style="color:#f92672">.</span><span style="color:#a6e22e">setParallelism</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
    DataStreamSource source <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">fromElements</span><span style="color:#f92672">(</span>
            <span style="color:#75715e">//浏览记录
</span><span style="color:#75715e"></span>            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Marry&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;外套&#34;</span><span style="color:#f92672">,</span> 1L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Marry&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">,</span>1L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Marry&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">,</span>2L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Marry&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">,</span>3L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Ming&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;衣服&#34;</span><span style="color:#f92672">,</span>1L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Marry&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;鞋子&#34;</span><span style="color:#f92672">,</span>1L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Marry&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;鞋子&#34;</span><span style="color:#f92672">,</span>2L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LiLei&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">,</span>1L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LiLei&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">,</span>2L<span style="color:#f92672">),</span>
            Tuple3<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LiLei&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">,</span>3L<span style="color:#f92672">)</span>
    <span style="color:#f92672">);</span>
    <span style="color:#75715e">//定义Pattern,寻找连续搜索帽子的用户
</span><span style="color:#75715e"></span>    Pattern<span style="color:#f92672">&lt;</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;,</span> Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;</span> pattern <span style="color:#f92672">=</span> Pattern
            <span style="color:#f92672">.&lt;</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;</span>begin<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;start&#34;</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">where</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SimpleCondition<span style="color:#f92672">&lt;</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;</span> value<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span> value<span style="color:#f92672">.</span><span style="color:#a6e22e">f1</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">})</span> <span style="color:#75715e">//.timesOrMore(3);
</span><span style="color:#75715e"></span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;middle&#34;</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">where</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SimpleCondition<span style="color:#f92672">&lt;</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;</span> value<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span> value<span style="color:#f92672">.</span><span style="color:#a6e22e">f1</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;帽子&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">});</span>

    KeyedStream keyedStream <span style="color:#f92672">=</span> source<span style="color:#f92672">.</span><span style="color:#a6e22e">keyBy</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
    PatternStream patternStream <span style="color:#f92672">=</span> CEP<span style="color:#f92672">.</span><span style="color:#a6e22e">pattern</span><span style="color:#f92672">(</span>keyedStream<span style="color:#f92672">,</span> pattern<span style="color:#f92672">);</span>
    SingleOutputStreamOperator matchStream <span style="color:#f92672">=</span> patternStream<span style="color:#f92672">.</span><span style="color:#a6e22e">select</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PatternSelectFunction<span style="color:#f92672">&lt;</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;,</span> String<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">select</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;&gt;</span> pattern<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
            List<span style="color:#f92672">&lt;</span>Tuple3<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;</span> middle <span style="color:#f92672">=</span> pattern<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;middle&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> middle<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">).</span><span style="color:#a6e22e">f0</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> middle<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">).</span><span style="color:#a6e22e">f2</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;连续搜索两次帽子!&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    matchStream<span style="color:#f92672">.</span><span style="color:#a6e22e">printToErr</span><span style="color:#f92672">();</span>
    env<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;execute cep&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上述代码的逻辑我们可以分解如下。</p>
<p>首先定义一个数据源，模拟了一些用户的搜索数据，然后定义了自己的 Pattern。这个模式的特点就是连续两次搜索商品“帽子”，然后进行匹配，发现匹配后输出一条提示信息，直接打印在控制台上。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF.png" data-sizes="auto" alt="提示信息" title="提示信息" class="lazyload"><figcaption class="image-caption">提示信息</figcaption></figure></p>
<p>可以看到，提示信息已经打印在了控制台上。</p>
<h2 id="总结">总结</h2>
<p>这一课时讲解了 Flink CEP 的支持和实现，并且模拟了一下简单的电商搜索场景来实现对连续搜索某一个商品的提示，关于模式匹配还有更加复杂的应用，比如识别网站的用户的爆破登录、运维监控等，建议你结合源码和官网进行深入的学习。</p>
<p><a href="https://github.com/wangzhiwubigdata/quickstart">点击这里下载本课程源码</a>。</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>追寻原风景 </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-12/>https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-12/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://xiaohao890809.github.io/tags/42%E8%AE%B2%E8%BD%BB%E6%9D%BE%E9%80%9A%E5%85%B3flink/">
                    #42讲轻松通关Flink</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://xiaohao890809.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-11/" class="prev" rel="prev" title="第10讲：Flink Side OutPut 分流"><i class="iconfont icon-left"></i>&nbsp;第10讲：Flink Side OutPut 分流</a>
         
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-13/" class="next" rel="next" title="第12讲：Flink 常用的 Source 和 Connector">第12讲：Flink 常用的 Source 和 Connector&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
        
    </div>

</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2015 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://xiaohao890809.github.io">追寻原风景</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>













    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
