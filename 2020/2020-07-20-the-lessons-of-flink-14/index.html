<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="追寻原风景">
  
  
  
  <link rel="prev" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-13/" />
  <link rel="next" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-15/" />
  <link rel="canonical" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-14/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           第13讲：如何实现生产环境中的 Flink 高可用配置 | 枕霞惜友
       
  </title>
  <meta name="title" content="第13讲：如何实现生产环境中的 Flink 高可用配置 | 枕霞惜友">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xiaohao890809.github.io"
    },
    "articleSection" : "posts",
    "name" : "第13讲：如何实现生产环境中的 Flink 高可用配置",
    "headline" : "第13讲：如何实现生产环境中的 Flink 高可用配置",
    "description" : "我们在第 06 课时“Flink 集群安装部署和 HA 配置”中讲解了 Flink 的几种常见部署模式，并且简单地介绍了 HA 配置。\n概述 事实上，集群的高可用（High Availablility，以下简称 HA）配置是大数据领域经典的一个问题。\n 通常 HA 用来描述一个系统经过专门的设计，从而减少停工时间，而保持其服务的高度可用性。\n 我们在第 03 课时“Flink 的编程模型与其他框架比较”中也提到过 Flink 集群中的角色，其中 JobManager 扮演的是集群管理者的角色，负责调度任务、协调 Checkpoints、协调故障恢复、收集 Job 的状态信息，并管理 Flink 集群中的从节点 TaskManager。\n在默认的情况下，我们的每个集群都只有一个 JobManager 实例，假如这个 JobManager 崩溃了，那么将会导致我们的作业运行失败，并且无法提交新的任务。\n因此，在生产环境中我们的集群应该如何配置以达到高可用的目的呢？针对不同模式进行部署的集群，我们需要不同的配置。\n源码分析 Flink 中的 JobManager、WebServer 等组件都需要高可用保障，并且 Flink 还需要进行 Checkpoint 元数据的持久化操作。与 Flink HA 相关的类图如下图所示，我们跟随源码简单看一下 Flink HA 的实现。\nHighAvailabilityMode 类中定义了三种高可用性模式枚举，如下图所示：\n NONE：非 HA 模式 ZOOKEEPER：基于 ZK 实现 HA FACTORY_CLASS：自定义 HA 工厂类，该类需要实现 HighAvailabilityServicesFactory 接口  具体的高可用实例对象创建则在 HighAvailabilityServicesUtils 类中有体现，如下图所示：",
    "inLanguage" : "en-us",
    "author" : "王知无",
    "creator" : "王知无",
    "publisher": "王知无",
    "accountablePerson" : "王知无",
    "copyrightHolder" : "王知无",
    "copyrightYear" : "2020",
    "datePublished": "2020-07-20 10:25:48 \u002b0000 UTC",
    "dateModified" : "2020-07-20 10:25:48 \u002b0000 UTC",
    "url" : "https:\/\/xiaohao890809.github.io\/2020\/2020-07-20-the-lessons-of-flink-14\/",
    "wordCount" : "580",
    "keywords" : [ "42讲轻松通关Flink", "枕霞惜友"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
        <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <div class="top-scroll-bar"></div>
    
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">第13讲：如何实现生产环境中的 Flink 高可用配置</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xiaohao890809.github.io" rel="author">王知无</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-07-20 itemprop="datePublished">July 20, 2020</time>
                </span>
                
        </div>
    </header>

    
          <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#源码分析">源码分析</a></li>
    <li><a href="#standalone-集群高可用配置">Standalone 集群高可用配置</a>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#文件配置">文件配置</a></li>
        <li><a href="#yarn-集群高可用配置">Yarn 集群高可用配置</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>
<script type="text/javascript">
  window.onload = function () {
    var fix = $('.post-toc');
    var end = $('.post-comment');
    var fixTop = fix.offset().top, fixHeight = fix.height();
    var endTop, miss;
    var offsetTop = fix[0].offsetTop;
    $(window).scroll(function () {
      var docTop = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
      if (end.length > 0) {
        endTop = end.offset().top;
        miss = endTop - docTop - fixHeight;
      }
      if (fixTop < docTop) {
        fix.css({ 'position': 'fixed' });
        if ((end.length > 0) && (endTop < (docTop + fixHeight))) {
          fix.css({ top: miss });
        } else {
          fix.css({ top: 0 });
        }
      } else {
        fix.css({ 'position': 'absolute' });
        fix.css({ top: offsetTop });
      }
    })
  }
</script> 
    

    <script type="text/javascript">
            window.MathJax = {
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
            TeX: {equationNumbers: {autoNumber: "AMS"}},
            showProcessingMessages: false,
            messageStyle: 'none'
        };
   </script>

    <script type="text/javascript" async src="/lib/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>

    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <p>我们在第 06 课时“Flink 集群安装部署和 HA 配置”中讲解了 Flink 的几种常见部署模式，并且简单地介绍了 HA 配置。</p>
<h2 id="概述">概述</h2>
<p>事实上，集群的高可用（High Availablility，以下简称 HA）配置是大数据领域经典的一个问题。</p>
<blockquote>
<p>通常 HA 用来描述一个系统经过专门的设计，从而减少停工时间，而保持其服务的高度可用性。</p>
</blockquote>
<p>我们在第 03 课时“Flink 的编程模型与其他框架比较”中也提到过 Flink 集群中的角色，其中 JobManager 扮演的是集群管理者的角色，负责调度任务、协调 Checkpoints、协调故障恢复、收集 Job 的状态信息，并管理 Flink 集群中的从节点 TaskManager。</p>
<p>在默认的情况下，我们的每个集群都只有一个 JobManager 实例，假如这个 JobManager 崩溃了，那么将会导致我们的作业运行失败，并且无法提交新的任务。</p>
<p>因此，在生产环境中我们的集群应该如何配置以达到高可用的目的呢？针对不同模式进行部署的集群，我们需要不同的配置。</p>
<h2 id="源码分析">源码分析</h2>
<p>Flink 中的 JobManager、WebServer 等组件都需要高可用保障，并且 Flink 还需要进行 Checkpoint 元数据的持久化操作。与 Flink HA 相关的类图如下图所示，我们跟随源码简单看一下 Flink HA 的实现。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E8%B7%9F%E9%9A%8F%E6%BA%90%E7%A0%81.jpg" data-sizes="auto" alt="跟随源码" title="跟随源码" class="lazyload"><figcaption class="image-caption">跟随源码</figcaption></figure></p>
<p>HighAvailabilityMode 类中定义了三种高可用性模式枚举，如下图所示：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/HighAvailabilityMode.png" data-sizes="auto" alt="HighAvailabilityMode" title="HighAvailabilityMode" class="lazyload"><figcaption class="image-caption">HighAvailabilityMode</figcaption></figure></p>
<ul>
<li>NONE：非 HA 模式</li>
<li>ZOOKEEPER：基于 ZK 实现 HA</li>
<li>FACTORY_CLASS：自定义 HA 工厂类，该类需要实现 HighAvailabilityServicesFactory 接口</li>
</ul>
<p>具体的高可用实例对象创建则在 HighAvailabilityServicesUtils 类中有体现，如下图所示：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1.png" data-sizes="auto" alt="实例对象" title="实例对象" class="lazyload"><figcaption class="image-caption">实例对象</figcaption></figure></p>
<p>创建 HighAvailabilityServices 的实例方法如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> HighAvailabilityServices <span style="color:#a6e22e">createHighAvailabilityServices</span><span style="color:#f92672">(</span>
        Configuration configuration<span style="color:#f92672">,</span>
        Executor executor<span style="color:#f92672">,</span>
        AddressResolution addressResolution<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        HighAvailabilityMode highAvailabilityMode <span style="color:#f92672">=</span> LeaderRetrievalUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getRecoveryMode</span><span style="color:#f92672">(</span>configuration<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>highAvailabilityMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">case</span> NONE<span style="color:#f92672">:</span>
                <span style="color:#75715e">// 省略部分代码
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// 返回非HA服务类实例
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> StandaloneHaServices<span style="color:#f92672">(</span>
                    resourceManagerRpcUrl<span style="color:#f92672">,</span>
                    dispatcherRpcUrl<span style="color:#f92672">,</span>
                    jobManagerRpcUrl<span style="color:#f92672">,</span>
                    String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s%s:%s&#34;</span><span style="color:#f92672">,</span> protocol<span style="color:#f92672">,</span> address<span style="color:#f92672">,</span> port<span style="color:#f92672">));</span>
            <span style="color:#66d9ef">case</span> ZOOKEEPER<span style="color:#f92672">:</span>
                BlobStoreService blobStoreService <span style="color:#f92672">=</span> BlobUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">createBlobStoreFromConfig</span><span style="color:#f92672">(</span>configuration<span style="color:#f92672">);</span>
                
                <span style="color:#75715e">// 返回ZK HA 服务类实例
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ZooKeeperHaServices<span style="color:#f92672">(</span>
                    ZooKeeperUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">startCuratorFramework</span><span style="color:#f92672">(</span>configuration<span style="color:#f92672">),</span>
                    executor<span style="color:#f92672">,</span>
                    configuration<span style="color:#f92672">,</span>
                    blobStoreService<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">case</span> FACTORY_CLASS<span style="color:#f92672">:</span>
                <span style="color:#75715e">// 返回自定义 HA 服务类实例
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> createCustomHAServices<span style="color:#f92672">(</span>configuration<span style="color:#f92672">,</span> executor<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Recovery mode &#34;</span> <span style="color:#f92672">+</span> highAvailabilityMode <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is not supported.&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>HighAvailabilityServices 接口定义了 HA 服务类应当实现的方法，实现类主要有 StandaloneHaServices（非 HA）、ZooKeeperHaServices、YarnHighAvailabilityServices。</p>
<p>ZooKeeperHaServices 主要提供了创建 LeaderRetrievalService 和 LeaderElectionService 等方法，并给出了各个服务组件使用的 ZK 节点名称。</p>
<p>ZooKeeperLeaderElectionService 实现了 LeaderElectionService 中 leader 选举和获取 leader 的方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">LeaderElectionService</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 启动 leader 选举服务
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>LeaderContender contender<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
    <span style="color:#75715e">// 停止 leader 选举服务
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">stop</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
    <span style="color:#75715e">// 获取新的 leader session ID
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">confirmLeaderSessionID</span><span style="color:#f92672">(</span>UUID leaderSessionID<span style="color:#f92672">);</span>
    <span style="color:#75715e">// 是否拥有 leader
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasLeadership</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nonnull</span> UUID leaderSessionId<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="standalone-集群高可用配置">Standalone 集群高可用配置</h2>
<h3 id="简介">简介</h3>
<p>如果你的集群是 Standalone 模式，那么此时需要对 JobManager 做主备，一般推荐一个<strong>主 JobManager</strong> 和多个<strong>备用的 JobManagers</strong>。当你的主 JobManager 发生故障时，备用的 JobManager 会接管集群，以保证我们的任务正常运行。这里需要注意的是，主和备 JobManager 只是我们人为的区分，实际上它们并没有区别，每一个 JobManager 都可以当作主或者备。</p>
<p>Standalone 模式下的 HA 配置，Flink 依赖 ZooKeeper 实现。ZooKeeper 集群独立于 Flink 集群之外，主要被用来进行 Leader 选举和轻量级状态一致性存储。更多关于 ZooKeeper 的资料可以直接<a href="https://zookeeper.apache.org/doc/current/">点击这里查看</a>。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E4%B8%80%E8%87%B4%E6%80%A7%E5%AD%98%E5%82%A8.png" data-sizes="auto" alt="一致性存储" title="一致性存储" class="lazyload"><figcaption class="image-caption">一致性存储</figcaption></figure></p>
<h3 id="文件配置">文件配置</h3>
<p>在这里我们要特别说明的是，Flink 自带了一个简单的 ZooKeeper 集群，并且提供了一键启动的脚本。在实际生产环境中建议自己搭建 ZooKeeper 集群，以方便我们进行配置管理。</p>
<p>假设我们在 3 台虚拟机之间搭建 standalone 集群，并且进行高可用配置：</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">hostname</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">192.168.2.100</td>
<td align="center">master</td>
<td align="center">主节点、ZK 01</td>
</tr>
<tr>
<td align="center">192.168.2.101</td>
<td align="center">slave01</td>
<td align="center">从节点 01、ZK 02</td>
</tr>
<tr>
<td align="center">192.168.2.102</td>
<td align="center">slave02</td>
<td align="center">从节点 02、ZK 03</td>
</tr>
</tbody>
</table>
<p>我们需要在 3 台机器上同时修改 Flink 配置文件中的 master 文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">master:8081
slave01:8081
slave02:8081
</code></pre></div><p>表示指定 ZooKeeper 集群的访问地址。
然后，需要修改 conf/flink-conf.yaml 文件，与高可用的配置相关的几个参数，如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">========================================================</span>
<span style="color:#960050;background-color:#1e0010">#</span> High Availability
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">=====================================================================</span>
high<span style="color:#f92672">-</span>availability<span style="color:#f92672">:</span> zookeeper
high<span style="color:#f92672">-</span>availability<span style="color:#f92672">.</span><span style="color:#a6e22e">zookeeper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">quorum</span><span style="color:#f92672">:</span> localhost<span style="color:#f92672">:</span>2181
high<span style="color:#f92672">-</span>availability<span style="color:#f92672">.</span><span style="color:#a6e22e">zookeeper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">path</span><span style="color:#f92672">.</span><span style="color:#a6e22e">root</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span>flink
high<span style="color:#f92672">-</span>availability<span style="color:#f92672">.</span><span style="color:#a6e22e">cluster</span><span style="color:#f92672">-</span>id<span style="color:#f92672">:</span> <span style="color:#f92672">/</span>cluster_one
high<span style="color:#f92672">-</span>availability<span style="color:#f92672">.</span><span style="color:#a6e22e">storageDir</span><span style="color:#f92672">:</span> hdfs<span style="color:#f92672">:</span><span style="color:#75715e">///flink/recovery
</span></code></pre></div><p>它们分别代表：</p>
<ul>
<li>high-availability，高可用性模式设置为 zookeeper，用来打开高可用模式；</li>
<li>high-availability.zookeeper.quorum，指定一组 ZooKeeper 服务器，它提供分布式协调服务，Flink 可以在指定的地址和端口访问 ZooKeeper；</li>
<li>high-availability.zookeeper.path.root，指定 ZooKeeper 的根节点，并且在该节点下放置所有集群节点；</li>
<li>high-availability.cluster-id，为每个集群指定一个 ID，用来存储该集群的相关数据；</li>
<li>high-availability.storageDir，高可用存储目录，JobManager 的元数据保存在文件系统 storageDir 中，一般来讲是 HDFS 的地址。</li>
</ul>
<p>对于 flink-conf.yaml 文件中的配置，除了 jobmanager.rpc.address 和 jobmanager.web.address 都各自配置自己机器的 IP 之外，其他的关于高可用的配置一模一样。</p>
<p>这里特别要注意下对于高可用性配置的部分。其中，high-availability、high-availability.storageDir 和 high-availability.zookeeper.quorum 这三项是必须配置的；后两项 high-availability.zookeeper.path.root 和 high-availability.cluster-id 配置是可选的，但是通常我们建议都手动进行配置，方便排查问题。</p>
<h3 id="yarn-集群高可用配置">Yarn 集群高可用配置</h3>
<p>与 Standalone 集群不同的是，Flink on Yarn 的高可用配置只需要一个 JobManager。当 JobManager 发生失败时，Yarn 负责将其重新启动。</p>
<p>我们需要修改 yarn-site.yaml 文件中的配置，如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">&lt;</span>property<span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;</span>name<span style="color:#f92672">&gt;</span>yarn<span style="color:#f92672">.</span><span style="color:#a6e22e">resourcemanager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">am</span><span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">-</span>attempts<span style="color:#f92672">&lt;/</span>name<span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;</span>value<span style="color:#f92672">&gt;</span>4<span style="color:#f92672">&lt;/</span>value<span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;</span>description<span style="color:#f92672">&gt;</span>
    The maximum number of application master execution attempts<span style="color:#f92672">.</span>
  <span style="color:#f92672">&lt;/</span>description<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;/</span>property<span style="color:#f92672">&gt;</span>
</code></pre></div><p>yarn.resourcemanager.am.max-attempts 表示 Yarn 的 application master 的最大重试次数。</p>
<p>除了上述 HA 配置之外，还需要配置 flink-conf.yaml 中的最大重试次数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">yarn<span style="color:#f92672">.</span><span style="color:#a6e22e">application</span><span style="color:#f92672">-</span>attempts<span style="color:#f92672">:</span> 10
</code></pre></div><p>默认情况下，该配置的值为 2：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5.png" data-sizes="auto" alt="默认情况" title="默认情况" class="lazyload"><figcaption class="image-caption">默认情况</figcaption></figure></p>
<p>我们在 Flink 的官网中可以查到，当你的 yarn.application-attempts 配置为 10 的时候：</p>
<blockquote>
<p>这意味着如果程序启动失败，YARN 会再重试 9 次（9 次重试 + 1 次启动），如果 YARN 启动 10 次作业还失败，则 YARN 才会将该任务的状态置为失败。如果发生进程抢占，节点硬件故障或重启，NodeManager 重新同步等，YARN 会继续尝试启动应用。 这些重启不计入 yarn.application-attempts 个数中。</p>
</blockquote>
<p><strong>同时官网给出了重要提示：</strong></p>
<ul>
<li><strong>YARN 2.3.0 &lt; version &lt; 2.4.0.</strong> All containers are restarted if the application master fails.</li>
<li><strong>YARN 2.4.0 &lt; version &lt; 2.6.0.</strong> TaskManager containers are kept alive across application master failures. This has the advantage that the startup time is faster and that the user does not have to wait for obtaining the container resources again.</li>
<li><strong>YARN 2.6.0</strong> &lt;= version: Sets the attempt failure validity interval to the Flinks’ Akka timeout value. The attempt failure validity interval says that an application is only killed after the system has seen the maximum number of application attempts during one interval. This avoids that a long lasting job will deplete it’s application attempts.</li>
</ul>
<p>不同 Yarn 版本的容器关闭行为不同，需要我们特别注意。</p>
<ul>
<li><strong>YARN 2.3.0 &lt; YARN 版本 &lt; 2.4.0</strong>。如果 application master 进程失败，则所有的 container 都会重启。</li>
<li><strong>YARN 2.4.0 &lt; YARN 版本 &lt; 2.6.0</strong>。TaskManager container 在 application master 故障期间，会继续工作。这样的优点是：启动时间更快，且缩短了所有 task manager 启动时申请资源的时间。</li>
<li><strong>YARN 2.6.0 &lt;= YARN 版本</strong>：失败重试的间隔会被设置为 Akka 的超时时间。在一次时间间隔内达到最大失败重试次数才会被置为失败。</li>
</ul>
<p>另外，需要注意的是，假如你的 ZooKeeper 集群使用 Kerberos 安全模式运行，那么可以根据需要添加下面的配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">zookeeper<span style="color:#f92672">.</span><span style="color:#a6e22e">sasl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">service</span><span style="color:#f92672">-</span>name
zookeeper<span style="color:#f92672">.</span><span style="color:#a6e22e">sasl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">login</span><span style="color:#f92672">-</span>context<span style="color:#f92672">-</span>name
</code></pre></div><p>如果你不想搭建自己的 ZooKeeper 集群或者简单地进行本地测试，你可以使用 Flink 自带的 ZooKeeper 集群，<strong>但是并不推荐</strong>，我们建议读者搭建自己的 ZooKeeper 集群。</p>
<h2 id="总结">总结</h2>
<p>本课时我们主要讲解了 Flink 集群的高可用配置，Standalone 和 Yarn 集群的配置有所不同。在生产环境中，Flink 集群的高可用配置必不可少，并且我们从源码上简单分析了高可用配置的原理。</p>
<p><a href="https://github.com/wangzhiwubigdata/quickstart">点击这里下载本课程源码</a>。</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>追寻原风景 </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-14/>https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-14/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://xiaohao890809.github.io/tags/42%E8%AE%B2%E8%BD%BB%E6%9D%BE%E9%80%9A%E5%85%B3flink/">
                    #42讲轻松通关Flink</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://xiaohao890809.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-13/" class="prev" rel="prev" title="第12讲：Flink 常用的 Source 和 Connector"><i class="iconfont icon-left"></i>&nbsp;第12讲：Flink 常用的 Source 和 Connector</a>
         
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-15/" class="next" rel="next" title="第14讲：Flink Exactly-once 实现原理解析">第14讲：Flink Exactly-once 实现原理解析&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
        
    </div>

</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2015 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://xiaohao890809.github.io">追寻原风景</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>













    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
