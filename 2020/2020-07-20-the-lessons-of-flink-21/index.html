<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="追寻原风景">
  
  
  
  <link rel="prev" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-20/" />
  <link rel="next" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-22/" />
  <link rel="canonical" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-21/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           第20讲：Flink 高级应用之海量数据高效去重 | 枕霞惜友
       
  </title>
  <meta name="title" content="第20讲：Flink 高级应用之海量数据高效去重 | 枕霞惜友">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xiaohao890809.github.io"
    },
    "articleSection" : "posts",
    "name" : "第20讲：Flink 高级应用之海量数据高效去重",
    "headline" : "第20讲：Flink 高级应用之海量数据高效去重",
    "description" : "本课时我们主要讲解 Flink 中的海量数据高效去重。\n消除重复数据是我们在实际业务中经常遇到的一类问题。在大数据领域，重复数据的删除有助于减少存储所需要的存储容量。而且在一些特定的业务场景中，重复数据是不可接受的，例如，精确统计网站一天的用户数量、在事实表中统计每天发出的快递包裹数量。在传统的离线计算中，我们可以直接用 SQL 通过 DISTINCT 函数，或者数据量继续增加时会用到类似 MapReduce 的思想。那么在实时计算中，去重计数是一个增量和长期的过程，并且不同的场景下因为效率和精度问题方案也需要变化。\n针对上述问题，我们在这里列出几种常见的 Flink 中实时去重方案：\n 基于状态后端 基于 HyperLogLog 基于布隆过滤器（BloomFilter） 基于 BitMap 基于外部数据库  下面我们依次讲解上述几种方案的适用场景和实现原理。\n基于状态后端 我们在第 09 课时“Flink 状态与容错”中曾经讲过 Flink State 状态后端的概念和原理，其中状态后端的种类之一是 RocksDBStateBackend。它会将正在运行中的状态数据保存在 RocksDB 数据库中，该数据库默认将数据存储在 TaskManager 运行节点的数据目录下。\nRocksDB 是一个 K-V 数据库，我们可以利用 MapState 进行去重。这里我们模拟一个场景，计算每个商品 SKU 的访问量。\n整体的实现代码如下：\npublic class MapStateDistinctFunction extends KeyedProcessFunction\u0026lt;String,Tuple2\u0026lt;String,Integer\u0026gt;,Tuple2\u0026lt;String,Integer\u0026gt;\u0026gt; { private transient ValueState\u0026lt;Integer\u0026gt; counts; @Override public void open(Configuration parameters) throws Exception { \/\/我们设置 ValueState 的 TTL 的生命周期为24小时，到期自动清除状态  StateTtlConfig ttlConfig = StateTtlConfig .",
    "inLanguage" : "en-us",
    "author" : "王知无",
    "creator" : "王知无",
    "publisher": "王知无",
    "accountablePerson" : "王知无",
    "copyrightHolder" : "王知无",
    "copyrightYear" : "2020",
    "datePublished": "2020-07-20 10:32:48 \u002b0000 UTC",
    "dateModified" : "2020-07-20 10:32:48 \u002b0000 UTC",
    "url" : "https:\/\/xiaohao890809.github.io\/2020\/2020-07-20-the-lessons-of-flink-21\/",
    "wordCount" : "458",
    "keywords" : [ "42讲轻松通关Flink", "枕霞惜友"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
        <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <div class="top-scroll-bar"></div>
    
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">第20讲：Flink 高级应用之海量数据高效去重</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xiaohao890809.github.io" rel="author">王知无</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-07-20 itemprop="datePublished">July 20, 2020</time>
                </span>
                
        </div>
    </header>

    
          <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#基于状态后端">基于状态后端</a></li>
    <li><a href="#基于-hyperloglog">基于 HyperLogLog</a></li>
    <li><a href="#基于布隆过滤器bloomfilter">基于布隆过滤器（BloomFilter）</a></li>
    <li><a href="#基于-bitmap">基于 BitMap</a></li>
    <li><a href="#基于外部数据库">基于外部数据库</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>
<script type="text/javascript">
  window.onload = function () {
    var fix = $('.post-toc');
    var end = $('.post-comment');
    var fixTop = fix.offset().top, fixHeight = fix.height();
    var endTop, miss;
    var offsetTop = fix[0].offsetTop;
    $(window).scroll(function () {
      var docTop = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
      if (end.length > 0) {
        endTop = end.offset().top;
        miss = endTop - docTop - fixHeight;
      }
      if (fixTop < docTop) {
        fix.css({ 'position': 'fixed' });
        if ((end.length > 0) && (endTop < (docTop + fixHeight))) {
          fix.css({ top: miss });
        } else {
          fix.css({ top: 0 });
        }
      } else {
        fix.css({ 'position': 'absolute' });
        fix.css({ top: offsetTop });
      }
    })
  }
</script> 
    

    <script type="text/javascript">
            window.MathJax = {
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
            TeX: {equationNumbers: {autoNumber: "AMS"}},
            showProcessingMessages: false,
            messageStyle: 'none'
        };
   </script>

    <script type="text/javascript" async src="/lib/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>

    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p>本课时我们主要讲解 Flink 中的海量数据高效去重。</p>
<p><strong>消除重复数据</strong>是我们在实际业务中经常遇到的一类问题。在大数据领域，重复数据的删除有助于减少存储所需要的存储容量。而且在一些特定的业务场景中，重复数据是不可接受的，例如，精确统计网站一天的用户数量、在事实表中统计每天发出的快递包裹数量。在传统的离线计算中，我们可以直接用 SQL 通过 DISTINCT 函数，或者数据量继续增加时会用到类似 MapReduce 的思想。那么在实时计算中，去重计数是一个增量和长期的过程，并且不同的场景下因为效率和精度问题方案也需要变化。</p>
<p>针对上述问题，我们在这里列出几种常见的 Flink 中实时去重方案：</p>
<ul>
<li>基于状态后端</li>
<li>基于 HyperLogLog</li>
<li>基于布隆过滤器（BloomFilter）</li>
<li>基于 BitMap</li>
<li>基于外部数据库</li>
</ul>
<p>下面我们依次讲解上述几种方案的适用场景和实现原理。</p>
<h2 id="基于状态后端">基于状态后端</h2>
<p>我们在第 09 课时“Flink 状态与容错”中曾经讲过 Flink State 状态后端的概念和原理，其中状态后端的种类之一是 <strong>RocksDBStateBackend</strong>。它会将正在运行中的状态数据保存在 RocksDB 数据库中，该数据库默认将数据存储在 TaskManager 运行节点的数据目录下。</p>
<p>RocksDB 是一个 K-V 数据库，我们可以利用 MapState 进行去重。这里我们模拟一个场景，计算每个商品 SKU 的访问量。</p>
<p>整体的实现代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MapStateDistinctFunction</span> <span style="color:#66d9ef">extends</span> KeyedProcessFunction<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Tuple2<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Integer<span style="color:#f92672">&gt;,</span>Tuple2<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Integer<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> ValueState<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> counts<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Configuration parameters<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#75715e">//我们设置 ValueState 的 TTL 的生命周期为24小时，到期自动清除状态
</span><span style="color:#75715e"></span>        StateTtlConfig ttlConfig <span style="color:#f92672">=</span> StateTtlConfig
                <span style="color:#f92672">.</span><span style="color:#a6e22e">newBuilder</span><span style="color:#f92672">(</span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flink</span><span style="color:#f92672">.</span><span style="color:#a6e22e">api</span><span style="color:#f92672">.</span><span style="color:#a6e22e">common</span><span style="color:#f92672">.</span><span style="color:#a6e22e">time</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Time</span><span style="color:#f92672">.</span><span style="color:#a6e22e">minutes</span><span style="color:#f92672">(</span>24 <span style="color:#f92672">*</span> 60<span style="color:#f92672">))</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">setUpdateType</span><span style="color:#f92672">(</span>StateTtlConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">UpdateType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">OnCreateAndWrite</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">setStateVisibility</span><span style="color:#f92672">(</span>StateTtlConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">StateVisibility</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NeverReturnExpired</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//设置 ValueState 的默认值
</span><span style="color:#75715e"></span>        ValueStateDescriptor<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> descriptor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ValueStateDescriptor<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;(</span><span style="color:#e6db74">&#34;skuNum&#34;</span><span style="color:#f92672">,</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        descriptor<span style="color:#f92672">.</span><span style="color:#a6e22e">enableTimeToLive</span><span style="color:#f92672">(</span>ttlConfig<span style="color:#f92672">);</span>
        counts <span style="color:#f92672">=</span> getRuntimeContext<span style="color:#f92672">().</span><span style="color:#a6e22e">getState</span><span style="color:#f92672">(</span>descriptor<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>parameters<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processElement</span><span style="color:#f92672">(</span>Tuple2<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;</span> value<span style="color:#f92672">,</span> Context ctx<span style="color:#f92672">,</span> Collector<span style="color:#f92672">&lt;</span>Tuple2<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;&gt;</span> out<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        String f0 <span style="color:#f92672">=</span> value<span style="color:#f92672">.</span><span style="color:#a6e22e">f0</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">//如果不存在则新增
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>counts<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            counts<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
            <span style="color:#75715e">//如果存在则加1
</span><span style="color:#75715e"></span>            counts<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>counts<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">()+</span>1<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>Tuple2<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>f0<span style="color:#f92672">,</span> counts<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">()));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在上面的这段代码里，我们实现了这样的逻辑：定义了一个 MapStateDistinctFunction 类，该类继承了 KeyedProcessFunction。核心的处理逻辑在 processElement 方法中，当一条数据经过，我们会在 MapState 中判断这条数据是否已经存在，如果不存在那么计数为 1，如果存在，那么在原来的计数上加 1。</p>
<p>这里需要注意的是，我们自定义了状态的过期时间是 24 小时，在实际生产中大量的 Key 会使得状态膨胀，我们可以对存储的 Key 进行处理。例如，使用加密方法把 Key 加密成几个字节进再存储。</p>
<h2 id="基于-hyperloglog">基于 HyperLogLog</h2>
<blockquote>
<p>HyperLogLog 是一种估计统计算法，被用来统计一个集合中不同数据的个数，也就是我们所说的去重统计。HyperLogLog 算法是用于基数统计的算法，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2 的 64 方个不同元素的基数。HyperLogLog 适用于大数据量的统计，因为成本相对来说是更低的，最多也就占用 12KB 内存。</p>
</blockquote>
<p>我们在不需要 100% 精确的业务场景下，可以使用这种方法进行统计。首先新增依赖：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>net<span style="color:#f92672">.</span><span style="color:#a6e22e">agkn</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>hll<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">6</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
</code></pre></div><p>我们还是以上述的商品 SKU 访问量作为业务场景，数据格式为 &lt;SKU, 访问的用户 id&gt;:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HyperLogLogDistinct</span> <span style="color:#66d9ef">implements</span> AggregateFunction<span style="color:#f92672">&lt;</span>Tuple2<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Long<span style="color:#f92672">&gt;,</span>HLL<span style="color:#f92672">,</span>Long<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> HLL <span style="color:#a6e22e">createAccumulator</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> HLL<span style="color:#f92672">(</span>14<span style="color:#f92672">,</span> 5<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> HLL <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Tuple2<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;</span> value<span style="color:#f92672">,</span> HLL accumulator<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//value 为访问记录 &lt;商品sku, 用户id&gt;
</span><span style="color:#75715e"></span>        accumulator<span style="color:#f92672">.</span><span style="color:#a6e22e">addRaw</span><span style="color:#f92672">(</span>value<span style="color:#f92672">.</span><span style="color:#a6e22e">f1</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> accumulator<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Long <span style="color:#a6e22e">getResult</span><span style="color:#f92672">(</span>HLL accumulator<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> cardinality <span style="color:#f92672">=</span> accumulator<span style="color:#f92672">.</span><span style="color:#a6e22e">cardinality</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> cardinality<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> HLL <span style="color:#a6e22e">merge</span><span style="color:#f92672">(</span>HLL a<span style="color:#f92672">,</span> HLL b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        a<span style="color:#f92672">.</span><span style="color:#a6e22e">union</span><span style="color:#f92672">(</span>b<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> a<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在上面的代码中，addRaw 方法用于向 HyperLogLog 中插入元素。如果插入的元素非数值型的，则需要 hash 过后才能插入。accumulator.cardinality() 方法用于计算 HyperLogLog 中元素的基数。</p>
<p>需要注意的是，HyperLogLog 并不是精准的去重，如果业务场景追求 100% 正确，那么一定不要使用这种方法。</p>
<h2 id="基于布隆过滤器bloomfilter">基于布隆过滤器（BloomFilter）</h2>
<blockquote>
<p>BloomFilter（布隆过滤器）类似于一个 HashSet，用于快速判断某个元素是否存在于集合中，其典型的应用场景就是能够快速判断一个 key 是否存在于某容器，不存在就直接返回。</p>
</blockquote>
<p>需要注意的是，和 HyperLogLog 一样，布隆过滤器不能保证 100% 精确。但是它的插入和查询效率都很高。</p>
<p>我们可以在非精确统计的情况下使用这种方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BloomFilterDistinct</span> <span style="color:#66d9ef">extends</span> KeyedProcessFunction<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">,</span> String<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> ValueState<span style="color:#f92672">&lt;</span>BloomFilter<span style="color:#f92672">&gt;</span> bloomState<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> ValueState<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> countState<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processElement</span><span style="color:#f92672">(</span>String value<span style="color:#f92672">,</span> Context ctx<span style="color:#f92672">,</span> Collector<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> out<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        BloomFilter bloomFilter <span style="color:#f92672">=</span> bloomState<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">();</span>
        Long skuCount <span style="color:#f92672">=</span> countState<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>bloomFilter <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            BloomFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>Funnels<span style="color:#f92672">.</span><span style="color:#a6e22e">unencodedCharsFunnel</span><span style="color:#f92672">(),</span> 10000000<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>skuCount <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            skuCount <span style="color:#f92672">=</span> 0L<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(!</span>bloomFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">mightContain</span><span style="color:#f92672">(</span>value<span style="color:#f92672">)){</span>
            bloomFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>value<span style="color:#f92672">);</span>
            skuCount <span style="color:#f92672">=</span> skuCount <span style="color:#f92672">+</span> 1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        bloomState<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>bloomFilter<span style="color:#f92672">);</span>
        countState<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>skuCount<span style="color:#f92672">);</span>
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>countState<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="基于-bitmap">基于 BitMap</h2>
<p>上面的 HyperLogLog 和 BloomFilter 虽然减少了存储但是丢失了精度， 这在某些业务场景下是无法被接受的。下面的这种方法不仅可以减少存储，而且还可以做到完全准确，那就是使用 BitMap。</p>
<blockquote>
<p>Bit-Map 的基本思想是用一个 bit 位来标记某个元素对应的 Value，而 Key 即是该元素。由于采用了 Bit 为单位来存储数据，因此可以大大节省存储空间。</p>
</blockquote>
<blockquote>
<p>假设有这样一个需求：在 20 亿个随机整数中找出某个数 m 是否存在其中，并假设 32 位操作系统，4G 内存。在 Java 中，int 占 4 字节，1 字节 = 8 位（1 byte = 8 bit）</p>
</blockquote>
<blockquote>
<p>如果每个数字用 int 存储，那就是 20 亿个 int，因而占用的空间约为 (2000000000 * 4/1024/1024/1024)≈7.45G</p>
</blockquote>
<blockquote>
<p>如果按位存储就不一样了，20 亿个数就是 20 亿位，占用空间约为 (2000000000/8/1024/1024/1024)≈0.233G</p>
</blockquote>
<p>在使用 BitMap 算法前，如果你需要去重的对象不是数字，那么需要先转换成数字。例如，用户可以自己创造一个映射器，将需要去重的对象和数字进行映射，最简单的办法是，可以直接使用数据库维度表中自增 ID。</p>
<p>首先我们新增一个依赖：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
   <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">roaringbitmap</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
   <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>RoaringBitmap<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
   <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
</code></pre></div><p>然后，我们还以商品的 SKU 的访问记录举例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BitMapDistinct</span> <span style="color:#66d9ef">implements</span> AggregateFunction<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">,</span> Roaring64NavigableMap<span style="color:#f92672">,</span>Long<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Roaring64NavigableMap <span style="color:#a6e22e">createAccumulator</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Roaring64NavigableMap<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Roaring64NavigableMap <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Long value<span style="color:#f92672">,</span> Roaring64NavigableMap accumulator<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        accumulator<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>value<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> accumulator<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Long <span style="color:#a6e22e">getResult</span><span style="color:#f92672">(</span>Roaring64NavigableMap accumulator<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> accumulator<span style="color:#f92672">.</span><span style="color:#a6e22e">getLongCardinality</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Roaring64NavigableMap <span style="color:#a6e22e">merge</span><span style="color:#f92672">(</span>Roaring64NavigableMap a<span style="color:#f92672">,</span> Roaring64NavigableMap b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在上述方法中，我们使用了 Roaring64NavigableMap，其是 BitMap 的一种实现，然后我们的数据是每次被访问的 SKU，把它直接添加到 Roaring64NavigableMap 中，最后通过 accumulator.getLongCardinality() 可以直接获取结果。</p>
<h2 id="基于外部数据库">基于外部数据库</h2>
<p>假如我们的业务场景非常复杂，并且数据量很大。为了防止无限制的状态膨胀，也不想维护庞大的 Flink 状态，我们可以采用外部存储的方式，比如可以选择使用 Redis 或者 HBase 存储数据，我们只需要设计好存储的 Key 即可。同时使用外部数据库进行存储，我们不需要关心 Flink 任务重启造成的状态丢失问题，但是有可能会出现因为重启恢复导致的数据多次发送，从而导致结果数据不准的问题。</p>
<h2 id="总结">总结</h2>
<p>这一课时我们讲解了多种不同的 Flink 大数据下的去重方法，并且详细比较了它们的异同。在实际的业务场景中，精确去重和非精确去重需要灵活选择不同的方案，在准确性和效率上达到统一。</p>
<p><a href="https://github.com/wangzhiwubigdata/quickstart">点击这里下载本课程源码</a>。</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>追寻原风景 </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-21/>https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-21/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://xiaohao890809.github.io/tags/42%E8%AE%B2%E8%BD%BB%E6%9D%BE%E9%80%9A%E5%85%B3flink/">
                    #42讲轻松通关Flink</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://xiaohao890809.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-20/" class="prev" rel="prev" title="第19讲：Flink 如何做维表关联"><i class="iconfont icon-left"></i>&nbsp;第19讲：Flink 如何做维表关联</a>
         
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-22/" class="next" rel="next" title="第21讲：Flink 在实时计算平台和实时数据仓库中的作用">第21讲：Flink 在实时计算平台和实时数据仓库中的作用&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
        
    </div>

</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2015 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://xiaohao890809.github.io">追寻原风景</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>













    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
