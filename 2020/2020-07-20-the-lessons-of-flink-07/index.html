<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="追寻原风景">
  
  
  
  <link rel="prev" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-06/" />
  <link rel="next" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-08/" />
  <link rel="canonical" href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-07/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           第06讲：Flink 集群安装部署和 HA 配置 | 枕霞惜友
       
  </title>
  <meta name="title" content="第06讲：Flink 集群安装部署和 HA 配置 | 枕霞惜友">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xiaohao890809.github.io"
    },
    "articleSection" : "posts",
    "name" : "第06讲：Flink 集群安装部署和 HA 配置",
    "headline" : "第06讲：Flink 集群安装部署和 HA 配置",
    "description" : "我们在这一课时将讲解 Flink 常见的部署模式：本地模式、Standalone 模式和 Flink On Yarn 模式，然后分别讲解三种模式的使用场景和部署中常见的问题，最后将讲解在生产环境中 Flink 集群的高可用配置。\nFlink 常见的部署模式 环境准备 在绝大多数情况下，我们的 Flink 都是运行在 Unix 环境中的，推荐在 Mac OS 或者 Linux 环境下运行 Flink。如果是集群模式，那么可以在自己电脑上安装虚拟机，保证有一个 master 节点和两个 slave 节点。\n同时，要注意在所有的机器上都应该安装 JDK 和 SSH。JDK 是我们运行 JVM 语言程序必须的，而 SSH 是为了在服务器之间进行跳转和执行命令所必须的。关于服务器之间通过 SSH 配置公钥登录，你可以直接搜索安装和配置方法，我们不做过度展开。\nFlink 的安装包可以在这里下载。需要注意的是，如果你要和 Hadoop 进行集成，那么我们需要使用到对应的 Hadoop 依赖，下面将会详细讲解。\nLocal 模式 Local 模式是 Flink 提供的最简单部署模式，一般用来本地测试和演示使用。\n我们在这里下载 Apache Flink 1.10.0 for Scala 2.11 版本进行演示，该版本对应 Scala 2.11 版本。\n将压缩包下载到本地，并且直接进行解压，使用 Flink 默认的端口配置，直接运行脚本启动：\n➜ [SoftWare]# tar -zxvf flink-1.10.0-bin-scala_2.11.tgz 上图则为解压完成后的目录情况。",
    "inLanguage" : "en-us",
    "author" : "王知无",
    "creator" : "王知无",
    "publisher": "王知无",
    "accountablePerson" : "王知无",
    "copyrightHolder" : "王知无",
    "copyrightYear" : "2020",
    "datePublished": "2020-07-20 10:15:48 \u002b0000 UTC",
    "dateModified" : "2020-07-20 10:15:48 \u002b0000 UTC",
    "url" : "https:\/\/xiaohao890809.github.io\/2020\/2020-07-20-the-lessons-of-flink-07\/",
    "wordCount" : "432",
    "keywords" : [ "42讲轻松通关Flink", "枕霞惜友"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
        <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <div class="top-scroll-bar"></div>
    
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xiaohao890809.github.io">枕霞惜友</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">第06讲：Flink 集群安装部署和 HA 配置</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xiaohao890809.github.io" rel="author">王知无</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-07-20 itemprop="datePublished">July 20, 2020</time>
                </span>
                
        </div>
    </header>

    
          <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#flink-常见的部署模式">Flink 常见的部署模式</a>
      <ul>
        <li><a href="#环境准备">环境准备</a></li>
        <li><a href="#local-模式">Local 模式</a></li>
        <li><a href="#standalone-模式">Standalone 模式</a></li>
      </ul>
    </li>
    <li><a href="#on-yarn-模式和-ha-配置">On Yarn 模式和 HA 配置</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>
<script type="text/javascript">
  window.onload = function () {
    var fix = $('.post-toc');
    var end = $('.post-comment');
    var fixTop = fix.offset().top, fixHeight = fix.height();
    var endTop, miss;
    var offsetTop = fix[0].offsetTop;
    $(window).scroll(function () {
      var docTop = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
      if (end.length > 0) {
        endTop = end.offset().top;
        miss = endTop - docTop - fixHeight;
      }
      if (fixTop < docTop) {
        fix.css({ 'position': 'fixed' });
        if ((end.length > 0) && (endTop < (docTop + fixHeight))) {
          fix.css({ top: miss });
        } else {
          fix.css({ top: 0 });
        }
      } else {
        fix.css({ 'position': 'absolute' });
        fix.css({ top: offsetTop });
      }
    })
  }
</script> 
    

    <script type="text/javascript">
            window.MathJax = {
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
            TeX: {equationNumbers: {autoNumber: "AMS"}},
            showProcessingMessages: false,
            messageStyle: 'none'
        };
   </script>

    <script type="text/javascript" async src="/lib/mathjax/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>

    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <p>我们在这一课时将讲解 Flink 常见的部署模式：本地模式、Standalone 模式和 Flink On Yarn 模式，然后分别讲解三种模式的使用场景和部署中常见的问题，最后将讲解在生产环境中 Flink 集群的高可用配置。</p>
<h2 id="flink-常见的部署模式">Flink 常见的部署模式</h2>
<h3 id="环境准备">环境准备</h3>
<p>在绝大多数情况下，我们的 Flink 都是运行在 Unix 环境中的，推荐在 Mac OS 或者 Linux 环境下运行 Flink。如果是集群模式，那么可以在自己电脑上安装虚拟机，保证有一个 master 节点和两个 slave 节点。</p>
<p>同时，要注意在所有的机器上都应该安装 JDK 和 SSH。JDK 是我们运行 JVM 语言程序必须的，而 SSH 是为了在服务器之间进行跳转和执行命令所必须的。关于服务器之间通过 SSH 配置公钥登录，你可以直接搜索安装和配置方法，我们不做过度展开。</p>
<p>Flink 的安装包可以在<a href="https://flink.apache.org/downloads.html">这里</a>下载。需要注意的是，如果你要和 Hadoop 进行集成，那么我们需要使用到对应的 Hadoop 依赖，下面将会详细讲解。</p>
<h3 id="local-模式">Local 模式</h3>
<p>Local 模式是 Flink 提供的最简单部署模式，一般用来本地测试和演示使用。</p>
<p>我们在<a href="https://flink.apache.org/downloads.html#apache-flink-1100">这里</a>下载 <a href="https://www.apache.org/dyn/closer.lua/flink/flink-1.10.0/flink-1.10.0-bin-scala_2.11.tgz">Apache Flink 1.10.0 for Scala 2.11</a> 版本进行演示，该版本对应 Scala 2.11 版本。</p>
<p>将压缩包下载到本地，并且直接进行解压，使用 Flink 默认的端口配置，直接运行脚本启动：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">➜  <span style="color:#f92672">[</span>SoftWare<span style="color:#f92672">]</span><span style="color:#75715e"># tar -zxvf flink-1.10.0-bin-scala_2.11.tgz</span>
</code></pre></div><p><figure><img src="/images/ring.svg" data-src="/images/%E7%9B%AE%E5%BD%95%E6%83%85%E5%86%B5.png" data-sizes="auto" alt="目录情况" title="目录情况" class="lazyload"><figcaption class="image-caption">目录情况</figcaption></figure></p>
<p>上图则为解压完成后的目录情况。</p>
<p>然后，我们可以直接运行脚本启动 Flink ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">➜  <span style="color:#f92672">[</span>flink-1.10.0<span style="color:#f92672">]</span><span style="color:#75715e"># ./bin/start-cluster.sh</span>
</code></pre></div><p><figure><img src="/images/ring.svg" data-src="/images/%E8%84%9A%E6%9C%AC%E5%90%AF%E5%8A%A8.png" data-sizes="auto" alt="脚本启动" title="脚本启动" class="lazyload"><figcaption class="image-caption">脚本启动</figcaption></figure></p>
<p>上图显示我们的 Flink 启动成功。</p>
<p>我们直接访问本地的 8081 端口，可以看到 Flink 的后台管理界面，验证 Flink 是否成功启动。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E6%88%90%E5%8A%9F%E5%90%AF%E5%8A%A8.png" data-sizes="auto" alt="成功启动" title="成功启动" class="lazyload"><figcaption class="image-caption">成功启动</figcaption></figure></p>
<p>可以看到 Flink 已经成功启动。当然，我们也可以查看运行日志来确认 Flink 是不是成功启动了，在 log 目录下有程序的启动日志：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97.png" data-sizes="auto" alt="启动日志" title="启动日志" class="lazyload"><figcaption class="image-caption">启动日志</figcaption></figure></p>
<p>我们尝试提交一个测试任务：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./bin/flink run examples/batch/WordCount.jar
</code></pre></div><p><figure><img src="/images/ring.svg" data-src="/images/%E6%B5%8B%E8%AF%95%E4%BB%BB%E5%8A%A1.png" data-sizes="auto" alt="测试任务" title="测试任务" class="lazyload"><figcaption class="image-caption">测试任务</figcaption></figure></p>
<p>我们在控制台直接看到输出。同样，在 Flink 的后台管理界面 Completed Jobs 一栏可以看到刚才提交执行的程序：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E7%9C%8B%E5%88%B0%E8%BE%93%E5%87%BA.png" data-sizes="auto" alt="看到输出" title="看到输出" class="lazyload"><figcaption class="image-caption">看到输出</figcaption></figure></p>
<h3 id="standalone-模式">Standalone 模式</h3>
<p>Standalone 模式是集群模式的一种，但是这种模式一般并不运行在生产环境中，原因和 on yarn 模式相比：</p>
<ul>
<li>Standalone 模式的部署相对简单，可以支持小规模，少量的任务运行；</li>
<li>Stabdalone 模式缺少系统层面对集群中 Job 的管理，容易遭成资源分配不均匀；</li>
<li>资源隔离相对简单，任务之间资源竞争严重。</li>
</ul>
<p>我们在 3 台虚拟机之间搭建 standalone 集群：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/standalone.png" data-sizes="auto" alt="standalone" title="standalone" class="lazyload"><figcaption class="image-caption">standalone</figcaption></figure></p>
<p>在 master 节点，将 Apache Flink 1.10.0 for Scala 2.11 包进行解压：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">➜  <span style="color:#f92672">[</span>SoftWare<span style="color:#f92672">]</span><span style="color:#75715e"># tar -zxvf flink-1.10.0-bin-scala_2.11.tgz</span>
</code></pre></div><p><strong>重点来啦</strong>，我们需要修改 Flink 的配置文件，并且将修改好的解压目录完整的拷贝到两个从节点中去。在这里，我强烈建议主节点和从节点的目录要保持一致。</p>
<p>我们修改 conf 目录下的 flink-conf.yaml:</p>
<p><figure><img src="/images/ring.svg" data-src="/images/flink-conf.png" data-sizes="auto" alt="flink-conf" title="flink-conf" class="lazyload"><figcaption class="image-caption">flink-conf</figcaption></figure></p>
<p>flink-conf.yaml 文件中有大量的配置参数，我们挑选其中必填的最基本参数进行修改：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">jobmanager<span style="color:#f92672">.</span><span style="color:#a6e22e">rpc</span><span style="color:#f92672">.</span><span style="color:#a6e22e">address</span><span style="color:#f92672">:</span> master
jobmanager<span style="color:#f92672">.</span><span style="color:#a6e22e">heap</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">:</span> 1024m
jobmanager<span style="color:#f92672">.</span><span style="color:#a6e22e">rpc</span><span style="color:#f92672">.</span><span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> 6123
taskmanager<span style="color:#f92672">.</span><span style="color:#a6e22e">memory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">process</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">:</span> 1568m
taskmanager<span style="color:#f92672">.</span><span style="color:#a6e22e">numberOfTaskSlots</span><span style="color:#f92672">:</span> 1
parallelism<span style="color:#f92672">.</span><span style="color:#a6e22e">default</span><span style="color:#f92672">:</span> 1
jobmanager<span style="color:#f92672">.</span><span style="color:#a6e22e">execution</span><span style="color:#f92672">.</span><span style="color:#a6e22e">failover</span><span style="color:#f92672">-</span>strategy<span style="color:#f92672">:</span> region
io<span style="color:#f92672">.</span><span style="color:#a6e22e">tmp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dirs</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span>tmp
</code></pre></div><p>它们分别代表：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E4%BB%A3%E8%A1%A8.png" data-sizes="auto" alt="代表" title="代表" class="lazyload"><figcaption class="image-caption">代表</figcaption></figure></p>
<p>如果你对其他的参数有兴趣的话，可以直接参考<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/zh/ops/config.html">官网</a>。</p>
<p>接下来我们修改 conf 目录下的 master 和 slave 文件。</p>
<p>vim master，将内容修改为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">master
</code></pre></div><p>vim slave，将内容修改为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">slave01
slave02
</code></pre></div><p>然后，将整个修改好的 Flink 解压目录使用 scp 远程拷贝命令发送到从节点：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">scp <span style="color:#f92672">-</span>r <span style="color:#f92672">/</span>SoftWare<span style="color:#f92672">/</span>flink<span style="color:#f92672">-</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">10</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0</span> slave01<span style="color:#f92672">:/</span>SoftWare<span style="color:#f92672">/</span>
scp <span style="color:#f92672">-</span>r <span style="color:#f92672">/</span>SoftWare<span style="color:#f92672">/</span>flink<span style="color:#f92672">-</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">10</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0</span> slave02<span style="color:#f92672">:/</span>SoftWare<span style="color:#f92672">/</span>
</code></pre></div><p>在 master、slave01、slave02 上分别配置环境变量，vim /etc/profile，将内容修改为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">export FLINK_HOME<span style="color:#f92672">=/</span>SoftWare<span style="color:#f92672">/</span>flink<span style="color:#f92672">-</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">10</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0</span>
export PATH<span style="color:#f92672">=</span>$PATH<span style="color:#f92672">:</span>$FLINK_HOME<span style="color:#f92672">/</span>bin
</code></pre></div><p>到此为止，我们整个的基础配置已经完成，下面需要启动集群，登录 master 节点执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">/SoftWare/flink-1.10.0/bin/start-cluster.sh
</code></pre></div><p>可以在浏览器访问：http://192.168.2.100:8081/ 检查集群是否启动成功。</p>
<p>集群搭建过程中，可能出现的问题：</p>
<ul>
<li>端口被占用，我们需要手动杀掉占用端口的程序；</li>
<li>目录找不到或者文件找不到，我们在 flink-conf.yaml 中配置过 io.tmp.dirs ，这个目录需要手动创建。</li>
</ul>
<h2 id="on-yarn-模式和-ha-配置">On Yarn 模式和 HA 配置</h2>
<p><figure><img src="/images/ring.svg" data-src="/images/%E6%A8%A1%E5%BC%8F.png" data-sizes="auto" alt="模式" title="模式" class="lazyload"><figcaption class="image-caption">模式</figcaption></figure></p>
<p>上图是 Flink on Yarn 模式下，Flink 和 Yarn 的交互流程。Yarn 是 Hadoop 三驾马车之一，主要用来做资源管理。我们在 Flink on Yarn 模式中也是借助 Yarn 的资源管理优势，需要在三个节点中配置 YARN_CONF_DIR、HADOOP_CONF_DIR、HADOOP_CONF_PATH 中的任意一个环境变量即可。</p>
<p>本课时中集群的高可用 HA 配置是基于独立的 ZooKeeper 集群。当然，Flink 本身提供了内置 ZooKeeper 插件，可以直接修改 conf/zoo.cfg，并且使用 /bin/start-zookeeper-quorum.sh 直接启动。</p>
<p>环境准备：</p>
<ul>
<li>ZooKeeper-3.x</li>
<li>Flink-1.10.0</li>
<li>Hadoop-2.6.5</li>
</ul>
<p>我们使用 5 台虚拟机搭建 on yarn 的高可用集群：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4.png" data-sizes="auto" alt="高可用集群" title="高可用集群" class="lazyload"><figcaption class="image-caption">高可用集群</figcaption></figure></p>
<p>如果你在使用 Flink 的最新版本 1.10.0 时，那么需要在本地安装 Hadoop 环境并进行下面的操作。</p>
<p>首先，添加环境变量：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vi /etc/profile
<span style="color:#75715e"># 添加环境变量</span>
export HADOOP_CONF_DIR<span style="color:#f92672">=</span>/Software/hadoop-2.6.5/etc/hadoop
<span style="color:#75715e"># 环境变量生效</span>
source /etc/profile
</code></pre></div><p>其次，下载对应的的依赖包，并将对应的 Hadoop 依赖复制到 flink 的 lib 目录下，对应的 hadoop 依赖可以在<a href="https://repo.maven.apache.org/maven2/org/apache/flink/flink-shaded-hadoop-2-uber/">这里</a>下载。</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E4%B8%8B%E8%BD%BD.png" data-sizes="auto" alt="下载" title="下载" class="lazyload"><figcaption class="image-caption">下载</figcaption></figure></p>
<p>与 standalone 集群不同的是，我们需要修改 flink-conf.yaml 文件中的一些配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">high-availability: zookeeper
high-availability.storageDir: hdfs://cluster/flinkha/
high-availability.zookeeper.quorum: slave01:2181,slave02:2181,slave03:2181
</code></pre></div><p>它们分别代表：</p>
<p><figure><img src="/images/ring.svg" data-src="/images/%E5%88%86%E5%88%AB%E4%BB%A3%E8%A1%A8.png" data-sizes="auto" alt="分别代表" title="分别代表" class="lazyload"><figcaption class="image-caption">分别代表</figcaption></figure></p>
<p>然后分别修改 master、slave、zoo.cfg 三个配置文件。
vim master，将内容修改为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">master01:8081
master02:8081
</code></pre></div><p>vim slave，将内容修改为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">slave01
slave02
slave03
</code></pre></div><p>vim zoo.cfg，将内容修改为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">server.1<span style="color:#f92672">=</span>slave01:2888:3888
server.2<span style="color:#f92672">=</span>slave02:2888:3888
server.3<span style="color:#f92672">=</span>slave03:2888:3888
</code></pre></div><p>然后，我们将整个修改好的 Flink 解压目录使用 scp 远程拷贝命令发送到从节点：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">scp -r /SoftWare/flink-1.10.0 slave01:/SoftWare/
scp -r /SoftWare/flink-1.10.0 slave02:/SoftWare/
scp -r /SoftWare/flink-1.10.0 slave03:/SoftWare/
</code></pre></div><p>分别启动 Hadoop 和 ZooKeeper，然后在主节点，使用命令启动集群：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">/SoftWare/flink-1.10.0/bin/start-cluster.sh
</code></pre></div><p>我们同样直接访问 http://192.168.2.100:8081/ 端口，可以看到 Flink 的后台管理界面，验证 Flink 是否成功启动。</p>
<p>在 Flink on yarn 模式下，启动集群的方式有两种：</p>
<ul>
<li>直接在 yarn 上运行任务</li>
<li>yarn session 模式</li>
</ul>
<p>直接在 yarn 上运行任务相当于将 job 直接提交到 yarn 上，每个任务会根据用户的指定进行资源申请，任务之间互不影响。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./bin/flink run -yjm 1024m -ytm 4096m -ys <span style="color:#ae81ff">2</span>  ./examples/batch/WordCount.jar
</code></pre></div><p>更多关于参数的含义，可以参考<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/ops/cli.html">官网</a>。</p>
<p>使用 yarn session 模式，我们需要先启动一个 yarn-session 会话，相当于启动了一个 yarn 任务，这个任务所占用的资源不会变化，并且一直运行。我们在使用 flink run 向这个 session 任务提交作业时，如果 session 的资源不足，那么任务会等待，直到其他资源释放。当这个 yarn-session 被杀死时，所有任务都会停止。</p>
<p>例如我们启动一个 yarn session 任务，该任务拥有 8G 内存、32 个槽位。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./bin/yarn-session.sh -tm <span style="color:#ae81ff">8192</span> -s <span style="color:#ae81ff">32</span>
</code></pre></div><p>我们在 yarn 的界面上可以看到这个任务的 ID，然后向这个 session ID 提交 Flink 任务：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./bin/flink run -m yarn-cluster -yid application_xxxx ./examples/batch/WordCount.jar
</code></pre></div><p>其中，application_xxxx 即为上述的 yarn session 任务 ID。</p>
<h2 id="总结">总结</h2>
<p>本课时我们讲解了 Flink 的三种部署模式和高可用配置，并且对这三种部署模式的适用场景进行了讲解。在生产上，我们最常用的方式当然是 Flink on Yarn，借助 Yarn 在资源管理上的绝对优势，确保集群和任务的稳定。</p>
<p><a href="https://github.com/wangzhiwubigdata/quickstart">点击这里下载本课程源码</a>。</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>追寻原风景 </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-07/>https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-07/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://xiaohao890809.github.io/tags/42%E8%AE%B2%E8%BD%BB%E6%9D%BE%E9%80%9A%E5%85%B3flink/">
                    #42讲轻松通关Flink</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://xiaohao890809.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-06/" class="prev" rel="prev" title="第05讲：Flink SQL &amp; Table 编程和案例"><i class="iconfont icon-left"></i>&nbsp;第05讲：Flink SQL &amp; Table 编程和案例</a>
         
        
        <a href="https://xiaohao890809.github.io/2020/2020-07-20-the-lessons-of-flink-08/" class="next" rel="next" title="第07讲：Flink 常见核心概念分析">第07讲：Flink 常见核心概念分析&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
        
    </div>

</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2015 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://xiaohao890809.github.io">追寻原风景</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>













    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
